---
title: 读《SQL 反模式》之关系型数据库中的树形结构设计总结
comments: true
date: 2017-04-16 20:57:18
tags:
- SQL
- Reading
---

# 前言
在厂长的多次推荐下，终于开始仔细研读《SQL 反模式》 一书。才翻看一章，就觉得相见恨晚，再次强烈推荐。

关于本文背景，在开发一些网站时，经常会遇到树形的数据结构，例如组织架构、论坛评论、分类信息等。这样的树形结构在存入关系型数据库时，要么存储多条信息保存一条数据的前后关系，要么以不灵活的方式存储结构关系。在以前的论坛开发中，我就遇到过评论数据无法合理存储的情况，最终是限定评论只能存两级。

要解决此类问题，需要考虑以下几种情况：
- 单个节点下的增删改查子节点
- 删除父节点时，树结构的变化，如果准确的删除所有子节点
- 通过节点查找以上所有祖先节点
- 

总之，在看此书前，都没能好好设计出一个方案解决此问题。感谢厂长推荐，感谢此书。

# 五个设计方案
以下面数据作为方案的典型数据加以讨论：
![树形结构数据](http://nutslog.qiniudn.com/17-4-16/13986620-file_1492350024445_cfe9.png)

在书中，共列举了 5 种方案，分别是**邻接表**、**递归查询**、**路径枚举**、**嵌套集**、**闭包集**。

## 邻接表
这是树形结构表设计中最为朴素的设计。

| COMMENT_ID | PARENT_ID | AUTHOR | COMMENT |
| --- | --- | --- | --- |
| 1 |   | Fran | 这个 Bug 的成因是什么 |
| 2	| 1	| Ollie | 我觉得是一个空指针 |
| 3	| 2	| Fran | 不，我查过了 |
| 4	| 1	| Kukla | 我们需要查无效输入 |
| 5	| 4	| Ollie | 是的，那是个问题 |
| 6	| 4	| Fran | 好，查一下吧 |
| 7	| 6	| Kukla | 解决了 |

**优点：**
在邻接表结构中，增删一个叶节点是非常简单的，并且改变一个叶节点的位置也十分简单。

**缺点：**
查找或删除一个非叶节点以及其所有后代，就十分困难，需要使用存储过程的循环了。
如果要删除一个子树，难度也与查找一个非叶节点一样。

由于邻接表这样的特性，使得其所能维持的树的层数十分受限。设想一下一张千万数据量的表中，如果有十多层树结构，就将查询该表十多次，效率是非常低的。
而且，对于维护树的完整性，也有所限制，例如要删除一个非叶节点，但不删除其子节点。在删除前必须修改其所有子节点的父节点，然后才能删除该非叶节点，这本身就是一段复杂的 SQL 命令，一旦执行出错，则子节点将找不到父节点，永远游离于树结构之外了。

## 递归查询
递归查询采用的表结构与邻接表结构是一致的，区别在于 SQL 语法的使用。
递归查询会用到 `with...as` 这种 `CTE（公共表表达式）`的方式，完成递归的查询。`with...as`的语法并不是所有的数据库版本都支持。

而对于`Oracle`数据库，可以用`start with...`与`connent by` 语法。
```SQL
SELECT * FROM COMMENT
START WITH COMMENT_ID = 4
CONNENT BY PARENT_ID = PRIOR COMMENT_ID
```

## 路径枚举
路径枚举的方法，是借鉴了 Unix 的目录结构，如`/usr/local/lib`。
通过在表结构中增加一列`PATH`列，来记录节点的所有的祖先的信息。

| COMMENT_ID | PATH | AUTHOR | COMMENT |
| --- | --- | --- | --- |
| 1 | /1 | Fran | 这个 Bug 的成因是什么 |
| 2 | /1/2 | Ollie | 我觉得是一个空指针 |
| 3 | /1/2/3 | Fran | 不，我查过了 |
| 4 | /1/4 | Kukla | 我们需要查无效输入 |
| 5 | /1/4/5 | Ollie | 是的，那是个问题 |
| 6 | /1/4/6 | Fran | 好，查一下吧 |
| 7 | /1/4/6/7 | Kukla | 解决了 |

**优点：**
查询，新增或删除一个叶节点非常的简单
查询一个非叶节点的子树也非常的简单

查询所有上层节点，可以这么写：
```SQL
SELECT * FROM T_COMMENT_2
WHERE '/1/4' LIKE CONCAT(PATH, '%');
```

相应的，查询评论 4 的所有子节点，可以这么写：
```
SELECT * FROM T_COMMENT_2
WHERE PATH LIKE '/1/4%'
```

**缺点：**
`PATH`字段作为一个有限长度的字符类型，限制了树形结构的无限的层级
如果要实现删除一个非叶节点，同时不删除其子节点，将非常困难


## 嵌套集

## 闭包集

# 方案间比较

| 方案 | 表数目 | 查询子 | 查询树 | 插入 | 删除叶 | 删除树 | 引用完整性 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 邻接表 | 1 | 简单 | 困难 | 简单 | 简单 | 困难 | 是 |
| 递归查询 | 1 | 简单 | 简单 | 简单 | 简单 | 简单 | 是 |
| 枚举路径 | 1 | 简单 | 简单 | 简单 | 简单 | 简单 | 否 |
| 嵌套集 | 1 | 困难 | 简单 | 困难 | 困难 | 简单 | 否 |
| 闭包集 | 2 | 简单 | 简单 | 简单 | 简单 | 简单 | 是 |


# 总结

# 参考资料

